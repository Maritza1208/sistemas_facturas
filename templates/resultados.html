<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üìä Resultados de Clasificaci√≥n</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- jQuery y DataTables -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f8fb;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 220px;
      height: 100vh;
      background: linear-gradient(180deg, #001429, #004085);
      padding: 30px 20px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      color: #fff;
    }

    .sidebar h5 {
      font-size: 22px;
      margin-bottom: 25px;
      color: #fff;
    }

    .sidebar-btn {
      display: block;
      width: 100%;
      background: rgba(209, 106, 106, 0.1);
      color: #fff;
      padding: 12px 15px;
      margin-bottom: 15px;
      text-decoration: none;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .sidebar-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateX(5px);
    }

    .sidebar-btn i {
      margin-right: 8px;
    }

    /* Empuja el contenido principal */
    .content {
      margin-left: 240px;
      padding: 30px;
    }

    h1 {
      color: #004085;
      margin-bottom: 30px;
    }

    .card + .card {
      margin-top: 30px;
    }

    #progressBar {
      height: 25px;
    }
  </style>
</head>
<body>

  <!-- üöÄ MEN√ö LATERAL -->
  <div class="sidebar">
    <h5 class="text-center">Men√∫</h5>
    <a href="{{ url_for('index') }}" class="sidebar-btn">
  <i class="bi bi-house-fill"></i> Inicio
    </a>
    <a href="#" id="btnCorregir" class="sidebar-btn">
      <i class="bi bi-gear-fill"></i> Correcci√≥n Autom√°tica
    </a>
    <a href="{{ url_for('vista_excel') }}" class="sidebar-btn">
      <i class="bi bi-eye-fill"></i> Vista Previa Excel
    </a>
    <form action="{{ url_for('descargar_excel_actualizado') }}" method="POST" class="d-inline">
      <button class="sidebar-btn" type="submit" style="border:none; background:none; padding:0; color:inherit;">
        <i class="bi bi-download"></i> Descargar Excel
      </button>
    </form>
    <a href="{{ url_for('ver_reportes') }}" class="sidebar-btn">
      <i class="bi bi-folder-fill"></i> Ver Reportes
    </a>

    <a href="{{ url_for('ver_manual') }}" class="sidebar-btn">
      <i class="bi bi-book-fill"></i> Manual de usuario
    </a>
    <!--<a href="{{ url_for('index') }}" class="sidebar-btn">
      <i class="bi bi-arrow-left-circle"></i> Volver al inicio
    </a>-->
  </div>

  <!-- üöÄ CONTENIDO PRINCIPAL -->
  <div class="content">
    <h1 class="text-center"><i class="bi bi-clipboard-data"></i> Resultados de Clasificaci√≥n de Facturas</h1>

    <!-- Facturas con Error XML -->
    {% if facturas_con_error %}
    <div class="card border-danger shadow-sm">
      <div class="card-header bg-danger text-white">
        <i class="bi bi-x-circle-fill"></i> Facturas con Error XML
      </div>
      <div class="card-body">
        <table id="tablaErroresXml" class="table table-striped table-hover">
          <thead class="table-light">
            <tr><th>Factura</th><th>Descripci√≥n</th><th>Observaci√≥n</th></tr>
          </thead>
          <tbody>
          {% for f in facturas_con_error %}
            <tr><td>{{ f.factura }}</td><td>{{ f.descripcion }}</td><td>{{ f.observacion }}</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- Facturas Corregidas -->
    {% if facturas_con_cuv_corregido %}
    <div class="card border-success shadow-sm">
      <div class="card-header bg-success text-white">
        <i class="bi bi-check-circle-fill"></i> Facturas Corregidas (CUV V√°lido)
      </div>
      <div class="card-body">
        <table id="tablaCuv" class="table table-striped table-hover">
          <thead class="table-light">
            <tr><th>Factura</th><th>Descripci√≥n</th><th>Observaci√≥n</th></tr>
          </thead>
          <tbody id="tbodyCuv">
          {% for f in facturas_con_cuv_corregido %}
            <tr><td>{{ f.factura }}</td><td>{{ f.descripcion }}</td><td>{{ f.observacion }}</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- Otros Errores -->
    {% if facturas_con_otros_errores %}
    <div class="card border-warning shadow-sm">
      <div class="card-header bg-warning text-dark">
        <i class="bi bi-exclamation-triangle-fill"></i> Otros Errores o Sin Archivos
      </div>
      <div class="card-body">
        <table id="tablaOtrosErrores" class="table table-striped table-hover">
          <thead class="table-light">
            <tr><th>Factura</th><th>Descripci√≥n</th><th>Observaci√≥n</th></tr>
          </thead>
          <tbody>
          {% for f in facturas_con_otros_errores %}
            <tr><td>{{ f.factura }}</td><td>{{ f.descripcion }}</td><td>{{ f.observacion }}</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- Barra de progreso -->
    <div class="progress my-4" id="progressBar">
      <div class="progress-bar progress-bar-striped bg-primary" role="progressbar"
           id="progressBarFill" style="width: 0%">0%</div>
    </div>
    <div id="alerta" class="text-center fw-bold"></div>

  </div>

  <!-- Bootstrap Bundle y DataTables -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let tableErrors, tableCuv;

  $(document).ready(function() {
    const langEs = {
      search: "üîç Buscar:",
      lengthMenu: "Mostrar _MENU_ registros",
      zeroRecords: "No se encontraron registros",
      info: "P√°gina _PAGE_ de _PAGES_",
      infoEmpty: "No hay registros",
      infoFiltered: "(filtrado de _MAX_ registros)",
      paginate: { next: "Siguiente", previous: "Anterior" }
    };

    // Inicializamos y guardamos instancias
    tableErrors = $('#tablaErroresXml').DataTable({ pageLength: 10, language: langEs });
    tableCuv    = $('#tablaCuv').DataTable    ({ pageLength: 10, language: langEs });
    $('#tablaOtrosErrores').DataTable({ pageLength: 10, language: langEs });
  });

  document.getElementById('btnCorregir').addEventListener('click', function(){
    if (!confirm("¬øDeseas aplicar la correcci√≥n autom√°tica?")) return;
    document.getElementById('progressBar').scrollIntoView({ behavior: 'smooth' });
    const xhr = new XMLHttpRequest();
    xhr.open("POST", "{{ url_for('corregir_y_enviar') }}", true);
    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    xhr.onreadystatechange = function() {
      if (xhr.readyState !== XMLHttpRequest.DONE) return;
      const alerta = document.getElementById('alerta');
      if (xhr.status === 200) {
        const response = JSON.parse(xhr.responseText);

        response.corregidas.forEach(f => {
          const fac = f.factura.toString();

          // 1) A√±adir fila a tabla CUV
          tableCuv.row.add([
            fac,
            'CUV generado correctamente', 
            'CUV validado'      
          ]).draw(false);

          // 2) Eliminar de tabla de errores
          tableErrors.rows((idx, data, node) => {
            return data[0].toString() === fac;
          }).remove().draw(false);
        });

        alerta.innerHTML = `‚úÖ Factura(s) corregidas: ${response.corregidas.map(f=>f.factura).join(', ')}`;
      } else {
        alerta.innerHTML = "‚ùå Error en la correcci√≥n autom√°tica.";
      }
    };

    // (Opcional) animar barra de progreso
    let progress = 0;
    const bar = document.getElementById('progressBarFill');
    const interval = setInterval(()=>{
      if (progress < 100) {
        progress += 5;
        bar.style.width = progress + "%";
        bar.textContent  = progress + "%";
      } else clearInterval(interval);
    }, 250);

    xhr.send(null);
  });
</script>
</body>
</html>
